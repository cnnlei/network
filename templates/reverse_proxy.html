{% extends "layout.html" %}
{% block content %}
<h1>反向代理站点管理</h1>
<p>在这里管理您的 HTTP/HTTPS 反向代理站点。服务会自动监听 80 和 443 端口。</p>
<button id="add-site-btn" class="button success">添加新站点</button>
<table id="sites-table">
    <thead>
        <tr>
            <th>状态</th>
            <th>主机名 (Hostname)</th>
            <th>后端服务</th>
            <th>SSL 模式</th>
            <th>当前连接</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        </tbody>
</table>

<div id="site-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="modal-close-btn">&times;</span>
        <h2 id="modal-title">添加新站点</h2>
        <form id="site-form">
            <input type="hidden" name="id">
            <div class="form-group">
                <label>主机名 (例如: app.yourdomain.com)</label>
                <input type="text" name="hostname" required>
            </div>
            <div class="form-group">
                <label>后端服务 URL (例如: http://127.0.0.1:3000)</label>
                <input type="url" name="backend_url" required>
            </div>
            <div class="form-group">
                <label>SSL 模式</label>
                <select name="ssl_mode" id="ssl-mode-select">
                    <option value="disabled">禁用 (仅 HTTP)</option>
                    <option value="manual">手动指定证书</option>
                    <option value="auto">自动申请 (Let's Encrypt)</option>
                </select>
            </div>
            <div id="manual-ssl-fields" style="display:none;">
                 <div class="form-group">
                    <label>证书文件绝对路径 (例如: /root/certs/fullchain.pem)</label>
                    <input type="text" name="ssl_cert_file">
                </div>
                <div class="form-group">
                    <label>私钥文件绝对路径 (例如: /root/certs/privkey.pem)</label>
                    <input type="text" name="ssl_key_file">
                </div>
            </div>
             <div id="auto-ssl-fields" style="display:none;">
                <p>将使用 config.ini 中配置的 Cloudflare API 进行 DNS-01 验证。</p>
            </div>
            <button type="submit" class="button">保存站点</button>
        </form>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const addSiteBtn = document.getElementById('add-site-btn');
    const modal = document.getElementById('site-modal');
    const closeModalBtn = document.getElementById('modal-close-btn');
    const siteForm = document.getElementById('site-form');
    const modalTitle = document.getElementById('modal-title');
    const sitesTableBody = document.querySelector('#sites-table tbody');
    const sslModeSelect = document.getElementById('ssl-mode-select');
    const manualSslFields = document.getElementById('manual-ssl-fields');

    // --- 函数：加载并刷新站点列表 ---
    async function loadSites() {
        try {
            const response = await fetch('/api/proxy/sites');
            const sites = await response.json();
            sitesTableBody.innerHTML = ''; // 清空表格

            if (sites.length === 0) {
                sitesTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">暂无站点，请添加一个。</td></tr>';
                return;
            }

            sites.forEach(site => {
                const row = `
                    <tr>
                        <td><span class="status-dot ${site.enabled ? 'active' : 'inactive'}"></span></td>
                        <td>${site.hostname}</td>
                        <td>${site.backend_url}</td>
                        <td>${site.ssl_mode.toUpperCase()}</td>
                        <td><span id="conn-count-${site.id}">0</span></td>
                        <td>
                            <button class="button">编辑</button>
                            <button class="button danger">删除</button>
                        </td>
                    </tr>
                `;
                sitesTableBody.insertAdjacentHTML('beforeend', row);
            });
        } catch (error) {
            Toast.show('加载站点列表失败', true);
        }
    }

    // --- 事件监听 ---
    addSiteBtn.addEventListener('click', () => {
        siteForm.reset(); // 清空表单
        modalTitle.textContent = '添加新站点';
        manualSslFields.style.display = 'none';
        modal.style.display = 'block';
    });

    closeModalBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    sslModeSelect.addEventListener('change', () => {
        manualSslFields.style.display = sslModeSelect.value === 'manual' ? 'block' : 'none';
    });

    siteForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(siteForm);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/api/proxy/sites', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            const result = await response.json();
            if (response.ok) {
                Toast.show(result.message);
                modal.style.display = 'none';
                loadSites(); // 重新加载列表
            } else {
                Toast.show(result.message, true);
            }
        } catch (error) {
            Toast.show('请求失败，请检查后端服务日志。', true);
        }
    });

    // 页面加载时立即加载站点列表
    loadSites();
});
</script>
{% endblock %}